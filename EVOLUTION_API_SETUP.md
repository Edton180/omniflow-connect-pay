# üîå Evolution API - Guia Completo de Configura√ß√£o

Documenta√ß√£o detalhada para configurar e usar a Evolution API com o OmniFlow.

## üìã √çndice

1. [O que √© Evolution API](#o-que-√©-evolution-api)
2. [Instala√ß√£o](#instala√ß√£o)
3. [Configura√ß√£o](#configura√ß√£o)
4. [Integra√ß√£o com OmniFlow](#integra√ß√£o-com-omniflow)
5. [Endpoints Principais](#endpoints-principais)
6. [Webhooks](#webhooks)
7. [Troubleshooting](#troubleshooting)

---

## ü§î O que √© Evolution API?

Evolution API √© uma API REST open-source para integra√ß√£o com WhatsApp, constru√≠da sobre a biblioteca Baileys. Oferece:

- ‚úÖ **M√∫ltiplas inst√¢ncias** simult√¢neas
- ‚úÖ **API REST** completa e documentada
- ‚úÖ **Webhooks** para eventos em tempo real
- ‚úÖ **Multi-dispositivo** (WhatsApp Business)
- ‚úÖ **Mensagens de texto, m√≠dia, √°udio, documentos**
- ‚úÖ **Grupos e listas de transmiss√£o**
- ‚úÖ **Respostas r√°pidas e templates**
- ‚úÖ **Alta disponibilidade**

**Reposit√≥rio oficial**: https://github.com/EvolutionAPI/evolution-api

---

## üì¶ Instala√ß√£o

### M√©todo 1: Docker (Recomendado)

```bash
# Crie diret√≥rio
mkdir -p /opt/evolution-api
cd /opt/evolution-api

# Crie docker-compose.yml
nano docker-compose.yml
```

```yaml
version: '3.8'

services:
  evolution-api:
    image: atendai/evolution-api:v2.1.1
    container_name: evolution-api
    restart: always
    ports:
      - "8080:8080"
    environment:
      # Server
      - SERVER_URL=https://api.seu-dominio.com
      - SERVER_PORT=8080
      
      # Authentication
      - AUTHENTICATION_API_KEY=${API_KEY}
      
      # Database
      - DATABASE_ENABLED=true
      - DATABASE_PROVIDER=postgresql
      - DATABASE_CONNECTION_URI=postgresql://user:pass@postgres:5432/evolution
      - DATABASE_SAVE_DATA_INSTANCE=true
      - DATABASE_SAVE_DATA_NEW_MESSAGE=true
      - DATABASE_SAVE_MESSAGE_UPDATE=true
      - DATABASE_SAVE_DATA_CONTACTS=true
      - DATABASE_SAVE_DATA_CHATS=true
      
      # Cache
      - CACHE_REDIS_ENABLED=true
      - CACHE_REDIS_URI=redis://redis:6379
      - CACHE_REDIS_PREFIX_KEY=evolution
      - CACHE_LOCAL_ENABLED=false
      
      # Storage
      - S3_ENABLED=false
      - S3_BUCKET=evolution
      
      # WhatsApp Config
      - CONFIG_SESSION_PHONE_CLIENT=OmniFlow
      - CONFIG_SESSION_PHONE_NAME=Chrome
      
      # Webhook
      - WEBHOOK_GLOBAL_ENABLED=false
      - WEBHOOK_GLOBAL_URL=
      - WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS=false
      
      # WebSocket
      - WEBSOCKET_ENABLED=true
      - WEBSOCKET_GLOBAL_EVENTS=false
      
      # Logs
      - LOG_LEVEL=ERROR
      - LOG_COLOR=true
      - LOG_BAILEYS=error
      
      # Other
      - DEL_INSTANCE=false
      - DEL_TEMP_INSTANCES=true
      
    volumes:
      - evolution_instances:/evolution/instances
      - evolution_store:/evolution/store
    depends_on:
      - postgres
      - redis
    networks:
      - evolution

  postgres:
    image: postgres:15-alpine
    container_name: evolution-postgres
    restart: always
    environment:
      - POSTGRES_USER=evolution
      - POSTGRES_PASSWORD=evolution_secure_password
      - POSTGRES_DB=evolution
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - evolution

  redis:
    image: redis:alpine
    container_name: evolution-redis
    restart: always
    command: >
      redis-server
      --appendonly yes
      --port 6379
    volumes:
      - redis_data:/data
    networks:
      - evolution

volumes:
  evolution_instances:
  evolution_store:
  postgres_data:
  redis_data:

networks:
  evolution:
    driver: bridge
```

Crie `.env`:
```env
API_KEY=gere_um_token_forte_aqui_min_32_caracteres
```

Inicie:
```bash
docker compose up -d

# Verifique logs
docker logs evolution-api -f
```

### M√©todo 2: Manual (Node.js)

```bash
# Clone reposit√≥rio
git clone https://github.com/EvolutionAPI/evolution-api.git
cd evolution-api

# Instale depend√™ncias
npm install

# Configure
cp .env.example .env
nano .env

# Build
npm run build

# Inicie com PM2
npm install -g pm2
pm2 start dist/src/main.js --name evolution-api
pm2 startup
pm2 save
```

---

## ‚öôÔ∏è Configura√ß√£o

### Vari√°veis de Ambiente Principais

```env
# === OBRIGAT√ìRIAS ===

# URL p√∫blica da API
SERVER_URL=https://api.seu-dominio.com

# Chave de autentica√ß√£o (min 32 caracteres)
AUTHENTICATION_API_KEY=seu_token_secreto_forte_aqui

# === BANCO DE DADOS (Recomendado) ===

DATABASE_ENABLED=true
DATABASE_PROVIDER=postgresql
DATABASE_CONNECTION_URI=postgresql://user:pass@host:5432/evolution

# === CACHE (Recomendado para produ√ß√£o) ===

CACHE_REDIS_ENABLED=true
CACHE_REDIS_URI=redis://localhost:6379

# === STORAGE ===

# Local (desenvolvimento)
S3_ENABLED=false

# S3 (produ√ß√£o recomendada)
S3_ENABLED=true
S3_ACCESS_KEY_ID=seu_access_key
S3_SECRET_ACCESS_KEY=seu_secret_key
S3_BUCKET=evolution
S3_REGION=us-east-1
S3_ENDPOINT=https://s3.amazonaws.com

# === WHATSAPP ===

CONFIG_SESSION_PHONE_CLIENT=OmniFlow
CONFIG_SESSION_PHONE_NAME=Chrome

# === WEBHOOKS ===

WEBHOOK_GLOBAL_ENABLED=true
WEBHOOK_GLOBAL_URL=https://seu-dominio.com/webhook
WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS=true

# === LOGS ===

LOG_LEVEL=ERROR
LOG_COLOR=true
LOG_BAILEYS=error
```

---

## üîó Integra√ß√£o com OmniFlow

### 1. Configure Secrets no Supabase

No dashboard do Supabase:
1. V√° em **Edge Functions**
2. Adicione secrets:
   - `EVOLUTION_API_URL`: `https://api.seu-dominio.com`
   - `EVOLUTION_API_KEY`: (seu token secreto)

### 2. No OmniFlow

1. Fa√ßa login como Super Admin
2. V√° em **Canais de Atendimento**
3. Clique em **Novo Canal**
4. Selecione **WhatsApp (Evolution API)**
5. Clique em **Salvar Configura√ß√£o**
6. Clique em **Conectar WhatsApp**
7. Escaneie o QR Code

---

## üì° Endpoints Principais

### Health Check
```bash
curl https://api.seu-dominio.com/health \
  -H "apikey: seu-token"
```

### Criar Inst√¢ncia
```bash
curl -X POST https://api.seu-dominio.com/instance/create \
  -H "apikey: seu-token" \
  -H "Content-Type: application/json" \
  -d '{
    "instanceName": "minha_instancia",
    "qrcode": true,
    "integration": "WHATSAPP-BAILEYS"
  }'
```

### Obter QR Code
```bash
curl https://api.seu-dominio.com/instance/connect/minha_instancia \
  -H "apikey: seu-token"
```

### Status da Conex√£o
```bash
curl https://api.seu-dominio.com/instance/connectionState/minha_instancia \
  -H "apikey: seu-token"
```

### Enviar Mensagem
```bash
curl -X POST https://api.seu-dominio.com/message/sendText/minha_instancia \
  -H "apikey: seu-token" \
  -H "Content-Type: application/json" \
  -d '{
    "number": "5511999999999",
    "text": "Ol√°! Esta √© uma mensagem de teste."
  }'
```

### Listar Inst√¢ncias
```bash
curl https://api.seu-dominio.com/instance/fetchInstances \
  -H "apikey: seu-token"
```

### Desconectar (Logout)
```bash
curl -X DELETE https://api.seu-dominio.com/instance/logout/minha_instancia \
  -H "apikey: seu-token"
```

### Deletar Inst√¢ncia
```bash
curl -X DELETE https://api.seu-dominio.com/instance/delete/minha_instancia \
  -H "apikey: seu-token"
```

---

## ü™ù Webhooks

Configure webhooks para receber eventos em tempo real:

### Configura√ß√£o Global

No `.env` ou ao criar inst√¢ncia:

```env
WEBHOOK_GLOBAL_ENABLED=true
WEBHOOK_GLOBAL_URL=https://seu-dominio.com/webhook
WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS=true
```

### Eventos Dispon√≠veis

- `messages.upsert` - Nova mensagem recebida
- `messages.update` - Mensagem atualizada
- `messages.delete` - Mensagem deletada
- `send.message` - Mensagem enviada
- `connection.update` - Status da conex√£o alterado
- `presence.update` - Status de presen√ßa alterado
- `chats.update` - Chat atualizado
- `chats.upsert` - Novo chat
- `chats.delete` - Chat deletado
- `contacts.update` - Contato atualizado
- `contacts.upsert` - Novo contato
- `groups.update` - Grupo atualizado
- `group-participants.update` - Participantes do grupo atualizados

### Exemplo de Payload

```json
{
  "event": "messages.upsert",
  "instance": "minha_instancia",
  "data": {
    "key": {
      "remoteJid": "5511999999999@s.whatsapp.net",
      "fromMe": false,
      "id": "3EB0XXXXX"
    },
    "message": {
      "conversation": "Ol√°!"
    },
    "messageType": "conversation",
    "messageTimestamp": 1234567890
  },
  "server_url": "https://api.seu-dominio.com",
  "apikey": "seu-token"
}
```

---

## üîß Troubleshooting

### Evolution API n√£o inicia

```bash
# Veja logs detalhados
docker logs evolution-api --tail 100 -f

# Verifique vari√°veis de ambiente
docker exec evolution-api env | grep -E "SERVER_URL|API_KEY|DATABASE"

# Teste conex√£o com banco
docker exec evolution-postgres psql -U evolution -c "\dt"
```

### QR Code n√£o conecta

1. Verifique se o WhatsApp est√° na vers√£o mais recente
2. Limpe cache do WhatsApp
3. Tente com outro telefone
4. Veja logs: `docker logs evolution-api -f`
5. Regenere QR Code (delete e crie nova inst√¢ncia)

### Mensagens n√£o enviam

```bash
# Verifique status da inst√¢ncia
curl https://api.seu-dominio.com/instance/connectionState/nome_instancia \
  -H "apikey: seu-token"

# Deve retornar: "state": "open"
```

### Erro "Instance not found"

```bash
# Liste inst√¢ncias
curl https://api.seu-dominio.com/instance/fetchInstances \
  -H "apikey: seu-token"

# Se n√£o aparecer, recrie a inst√¢ncia
```

---

## üîÑ Atualiza√ß√µes

### Atualizar Evolution API

```bash
cd /opt/evolution-api

# Pare containers
docker compose down

# Atualize imagem
docker pull atendai/evolution-api:latest

# Reinicie
docker compose up -d

# Verifique
docker logs evolution-api -f
```

---

## üìä Monitoramento

### Logs em Tempo Real

```bash
# Evolution API
docker logs evolution-api -f

# PostgreSQL
docker logs evolution-postgres -f

# Redis
docker logs evolution-redis -f
```

### M√©tricas de Recursos

```bash
# CPU e Mem√≥ria
docker stats

# Disco
docker system df
```

### Portainer (Interface Gr√°fica)

```bash
# Instale Portainer
docker run -d -p 9000:9000 \
  --name=portainer --restart=always \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v portainer_data:/data \
  portainer/portainer-ce:latest
```

Acesse: `http://seu-servidor:9000`

---

## üõ°Ô∏è Seguran√ßa

### Pr√°ticas Recomendadas

1. **Use HTTPS sempre** (Let's Encrypt)
2. **Proteja sua API key** (min 32 caracteres aleat√≥rios)
3. **Configure firewall** (UFW ou iptables)
4. **Backups regulares** do banco de dados e inst√¢ncias
5. **Monitore logs** para atividades suspeitas
6. **Rate limiting** no Nginx

### Nginx Rate Limiting

```nginx
# No bloco http
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

# No server da API
server {
    location / {
        limit_req zone=api_limit burst=20 nodelay;
        proxy_pass http://localhost:8080;
    }
}
```

---

## üîå Integra√ß√£o Avan√ßada

### Enviar M√≠dia

```bash
curl -X POST https://api.seu-dominio.com/message/sendMedia/instance \
  -H "apikey: token" \
  -H "Content-Type: application/json" \
  -d '{
    "number": "5511999999999",
    "mediatype": "image",
    "media": "https://exemplo.com/imagem.jpg",
    "caption": "Confira esta imagem!"
  }'
```

### Criar Grupo

```bash
curl -X POST https://api.seu-dominio.com/group/create/instance \
  -H "apikey: token" \
  -H "Content-Type: application/json" \
  -d '{
    "subject": "Meu Grupo",
    "participants": ["5511999999999", "5511888888888"]
  }'
```

### Listar Chats

```bash
curl https://api.seu-dominio.com/chat/findChats/instance \
  -H "apikey: token"
```

---

## üìà Otimiza√ß√£o para Produ√ß√£o

### PostgreSQL

```sql
-- Otimize o banco
VACUUM ANALYZE;

-- √çndices recomendados
CREATE INDEX IF NOT EXISTS idx_messages_instance ON messages(instance_name);
CREATE INDEX IF NOT EXISTS idx_messages_timestamp ON messages(timestamp);
CREATE INDEX IF NOT EXISTS idx_chats_instance ON chats(instance_name);
```

### Redis Cache

```bash
# No docker-compose.yml, configure Redis com persist√™ncia
redis:
  command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
```

### Nginx Cache

```nginx
# Cache para assets est√°ticos
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    expires 30d;
    add_header Cache-Control "public, immutable";
}

# Sem cache para API
location /api/ {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
}
```

---

## üéØ Casos de Uso

### 1. Atendimento Automatizado

```javascript
// Webhook handler
app.post('/webhook', (req, res) => {
  const { event, data } = req.body;
  
  if (event === 'messages.upsert' && !data.key.fromMe) {
    const message = data.message?.conversation;
    const from = data.key.remoteJid;
    
    // Resposta autom√°tica
    if (message.toLowerCase().includes('hor√°rio')) {
      sendMessage(from, 'Atendemos de segunda a sexta, 9h √†s 18h.');
    }
  }
  
  res.json({ success: true });
});
```

### 2. Notifica√ß√µes em Massa

```javascript
async function sendBulkMessages(recipients, message) {
  for (const number of recipients) {
    await fetch(`${EVOLUTION_URL}/message/sendText/${instance}`, {
      method: 'POST',
      headers: {
        'apikey': API_KEY,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        number: number,
        text: message
      })
    });
    
    // Aguarde 1 segundo entre mensagens
    await new Promise(resolve => setTimeout(resolve, 1000));
  }
}
```

### 3. Chatbot com IA

```javascript
// Integre com sua AI preferida
async function handleMessage(from, message) {
  // Chame sua IA
  const aiResponse = await callAI(message);
  
  // Envie resposta
  await fetch(`${EVOLUTION_URL}/message/sendText/${instance}`, {
    method: 'POST',
    headers: { 'apikey': API_KEY, 'Content-Type': 'application/json' },
    body: JSON.stringify({
      number: from,
      text: aiResponse
    })
  });
}
```

---

## üìö Recursos Adicionais

- **Documenta√ß√£o Oficial**: https://doc.evolution-api.com
- **GitHub**: https://github.com/EvolutionAPI/evolution-api
- **Postman Collection**: Dispon√≠vel no reposit√≥rio
- **Swagger UI**: `https://api.seu-dominio.com/docs`

---

## üí° Dicas de Performance

1. **Use Redis** para cache em produ√ß√£o
2. **Configure PostgreSQL** para otimizar queries
3. **Limite inst√¢ncias simult√¢neas** (4-8 por servidor de 4GB RAM)
4. **Use Load Balancer** para alta disponibilidade
5. **Monitore recursos** com Portainer ou Grafana
6. **Backups autom√°ticos** do banco e volumes

---

## üÜò Suporte

- Evolution API Issues: https://github.com/EvolutionAPI/evolution-api/issues
- OmniFlow Issues: https://github.com/seu-usuario/omniflow/issues
- Documenta√ß√£o: `/DEPLOY.md` e `/INSTALLATION.md`

---

**Evolution API integrada ao OmniFlow = Solu√ß√£o profissional de WhatsApp!** üöÄüì±
